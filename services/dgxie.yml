apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: dgxie
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: dgxie
    spec:
      hostNetwork: true
      nodeSelector:
        node-role.kubernetes.io/master: "true"
      containers:
        - name: dgxie
          image: dgxie:latest
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
          volumeMounts:
            # Path for DHCP host-specific config, DO NOT MODIFY
            - name: dhcp-config-volume
              mountPath: "/etc/dnsmasq.d"
            - name: dhcp-leases
              mountPath: "/var/lib/misc/"
            #- name: pxe-config-volume
            #  mountPath: /tftpboot/pxelinux.cfg
            # Path for NFS mount, DO NOT MODIFY
            - name: nfs
              mountPath: "/nfs"
          env:
            # Path in container to mounted DGX ISO
            - name: ISO
              value: "/iso"
            # Default DGX boot mode
            # Options:
            #   "DGX":   boot DGX to install media
            #   "local": boot DGX to local disk
            - name: DEFAULT
              value: "DGX"
            # DGX network interface to use during install
            - name: INT
              value: "enp1s0f0"
            # DGX disk to use during install
            - name: DISK
              value: "sda"
            # DGX Keyboard layout to use
            - name: KBD
              value: "us"
            # Extra kernel parameters to pass during DGX OS install
            # i.e. "rebuild-raid"
            - name: KERN_EXTRA
              value: ""
            # Network interface of public network on management servers
            - name: HOST_INT_PUB
              value: "eth0"
            # Network interface of private network where DGX are connected on management servers
            - name: HOST_INT_PRV
              value: "eth1"
            # Network domain
            - name: DOMAIN
              value: "local"
            # IP address of private network interface on management server
            - name: IP
              value: "192.168.1.1"
            # Private Network
            - name: NETWORK
              value: "192.168.1.0"
            # Private network netmask
            - name: NETMASK
              value: "255.255.255.0"
            # Private network gateway
            - name: GATEWAY
              value: "192.168.1.1"
            # DNS nameservers
            - name: DNS1
              value: "192.168.1.1"
            - name: DNS2
              value: "8.8.8.8"
            # DHCP dynamic address range
            - name: DHCP_START
              value: "192.168.1.100"
            - name: DHCP_END
              value: "192.168.1.199"
            # DHCP lease time
            - name: LEASETIME
              value: "7200"
            # HTTP port for HTTP server
            - name: HTTP_PORT
              value: "13370"
      volumes:
        - name: dhcp-config-volume
          configMap:
            name: dhcpd
        - name: nfs
          nfs:
            server: nfs-server.default.svc.cluster.local
            path: /
        - name: dhcp-leases
          persistentVolumeClaim:
            claimName: dhcp-leases
        #- name: pxe-config-volume
        #  configMap:
        #    name: pxe-login
        #    items:
        #    - key: 01-0c-c4-7a-a3-3e-94
        #      path: 01-0c-c4-7a-a3-3e-94
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: dhcp-leases
  labels:
    app: dgxie
  annotations:
    volume.alpha.kubernetes.io/storage-class: default
spec:
  storageClassName: rook-ceph-block
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10M
